
.. DO NOT EDIT.
.. THIS FILE WAS AUTOMATICALLY GENERATED BY SPHINX-GALLERY.
.. TO MAKE CHANGES, EDIT THE SOURCE PYTHON FILE:
.. "examples/plot_epsfmodel.py"
.. LINE NUMBERS ARE GIVEN BELOW.

.. only:: html

    .. note::
        :class: sphx-glr-download-link-note

        Click :ref:`here <sphx_glr_download_examples_plot_epsfmodel.py>`
        to download the full example code

.. rst-class:: sphx-glr-example-title

.. _sphx_glr_examples_plot_epsfmodel.py:


===================
PSF Model Construction
===================

Demonstration of building an ePSF model from Gaia stars in an LCO image.

.. GENERATED FROM PYTHON SOURCE LINES 8-36

.. code-block:: default


    import os
    import diffimageml
    from matplotlib import pyplot as plt


    # Hard coding the test data filenames
    _EXAMPLEDATADIR_ = diffimageml.get_example_data_dir()

    _DIFFIM1_ = os.path.abspath(os.path.join(
        _EXAMPLEDATADIR_, 'diff_pydia_1.fits.fz'))
    _FAKEDIFFIM1_ = os.path.abspath(os.path.join(
        _EXAMPLEDATADIR_, 'diff_pydia_1_fakegrid.fits'))
    _SEARCHIM1_ = os.path.abspath(os.path.join(
        _EXAMPLEDATADIR_, 'sky_image_1.fits.fz'))
    _TEMPLATEIM1_ = os.path.abspath(os.path.join(
        _EXAMPLEDATADIR_, 'template_1.fits.fz'))

    _DIFFIM2_ = os.path.abspath(os.path.join(
        _EXAMPLEDATADIR_, 'diff_pydia_2.fits.fz'))
    _FAKEDIFFIM2_ = os.path.abspath(os.path.join(
        _EXAMPLEDATADIR_, 'diff_pydia_2_fakegrid.fits'))
    _SEARCHIM2_ = os.path.abspath(os.path.join(
        _EXAMPLEDATADIR_, 'sky_image_2.fits.fz'))
    _TEMPLATEIM2_ = os.path.abspath(os.path.join(
        _EXAMPLEDATADIR_, 'template_2.fits.fz'))






.. rst-class:: sphx-glr-script-out

 Out:

 .. code-block:: none

    Created TAP+ (v1.2.1) - Connection:
            Host: gea.esac.esa.int
            Use HTTPS: True
            Port: 443
            SSL Port: 443
    Created TAP+ (v1.2.1) - Connection:
            Host: geadata.esac.esa.int
            Use HTTPS: True
            Port: 443
            SSL Port: 443




.. GENERATED FROM PYTHON SOURCE LINES 39-53

PSF Model Construction Overview
-------------------------------

To construct a PSF model we go through the following steps

* Load an example fits image

* Fetch a catalog of stars in the image from the Gaia db

* Do photometry of the Gaia stars

* Measure the zero point for the image.

* Build an ePSF model from the Gaia stars

.. GENERATED FROM PYTHON SOURCE LINES 53-57

.. code-block:: default


    assert(os.path.isfile(_SEARCHIM1_))
    searchim = diffimageml.FitsImage(_SEARCHIM1_)





.. rst-class:: sphx-glr-script-out

 Out:

 .. code-block:: none

    /usr/local/anaconda3/envs/astroconda/lib/python3.7/site-packages/astropy/wcs/wcs.py:709: FITSFixedWarning: 'obsfix' made the change 'Set OBSGEO-L to   149.070647 from OBSGEO-[XYZ].
    Set OBSGEO-B to   -31.272933 from OBSGEO-[XYZ].
    Set OBSGEO-H to     1164.993 from OBSGEO-[XYZ]'.
      FITSFixedWarning)




.. GENERATED FROM PYTHON SOURCE LINES 58-60

Fetch a catalog of stars in the image from the Gaia db
(or read in a saved local copy)

.. GENERATED FROM PYTHON SOURCE LINES 60-65

.. code-block:: default


    searchim.fetch_gaia_sources(overwrite=False)
    searchim.plot_gaia_sources(magmin=12, magmax=18)





.. image:: /examples/images/sphx_glr_plot_epsfmodel_001.png
    :alt: Locations of Gaia Sources with 12<mag<18
    :class: sphx-glr-single-img


.. rst-class:: sphx-glr-script-out

 Out:

 .. code-block:: none

    Gaia catalog /Users/rodney/Dropbox/src/diffimageml/diffimageml/test_data/sky_image_1_GaiaCat.ecsv exists. 
    Reading without fetching.




.. GENERATED FROM PYTHON SOURCE LINES 66-68

Do photometry of the Gaia stars, within a user-specified
magnitude range

.. GENERATED FROM PYTHON SOURCE LINES 68-72

.. code-block:: default

    searchim.do_stellar_photometry(searchim.gaia_source_table)

    searchim.plot_stellar_photometry()




.. image:: /examples/images/sphx_glr_plot_epsfmodel_002.png
    :alt: plot epsfmodel
    :class: sphx-glr-single-img


.. rst-class:: sphx-glr-script-out

 Out:

 .. code-block:: none

    /Users/rodney/Dropbox/src/diffimageml/diffimageml/fakeplanting.py:628: RuntimeWarning: invalid value encountered in log10
      phot['mag'] = -2.5 * np.log10( phot['aper_sum_bkgsub'] )




.. GENERATED FROM PYTHON SOURCE LINES 73-74

Measure the zero point for this image from the Gaia stars

.. GENERATED FROM PYTHON SOURCE LINES 74-77

.. code-block:: default

    searchim.measure_zeropoint(showplot=True)





.. image:: /examples/images/sphx_glr_plot_epsfmodel_003.png
    :alt: plot epsfmodel
    :class: sphx-glr-single-img


.. rst-class:: sphx-glr-script-out

 Out:

 .. code-block:: none

    /Users/rodney/Dropbox/src/diffimageml/diffimageml/fakeplanting.py:704: RuntimeWarning: divide by zero encountered in true_divide
      (np.abs(star_flux/star_flux_err)>20))
    /usr/local/anaconda3/envs/astroconda/lib/python3.7/site-packages/numpy/core/fromnumeric.py:748: UserWarning: Warning: 'partition' will ignore the 'mask' of the MaskedArray.
      a.partition(kth, axis=axis, kind=kind, order=order)
    /usr/local/anaconda3/envs/astroconda/lib/python3.7/site-packages/numpy/core/fromnumeric.py:748: UserWarning: Warning: 'partition' will ignore the 'mask' of the MaskedArray.
      a.partition(kth, axis=axis, kind=kind, order=order)
    /usr/local/anaconda3/envs/astroconda/lib/python3.7/site-packages/numpy/core/fromnumeric.py:748: UserWarning: Warning: 'partition' will ignore the 'mask' of the MaskedArray.
      a.partition(kth, axis=axis, kind=kind, order=order)
    /usr/local/anaconda3/envs/astroconda/lib/python3.7/site-packages/numpy/core/fromnumeric.py:748: UserWarning: Warning: 'partition' will ignore the 'mask' of the MaskedArray.
      a.partition(kth, axis=axis, kind=kind, order=order)
    /usr/local/anaconda3/envs/astroconda/lib/python3.7/site-packages/numpy/core/fromnumeric.py:748: UserWarning: Warning: 'partition' will ignore the 'mask' of the MaskedArray.
      a.partition(kth, axis=axis, kind=kind, order=order)
    /usr/local/anaconda3/envs/astroconda/lib/python3.7/site-packages/numpy/core/fromnumeric.py:748: UserWarning: Warning: 'partition' will ignore the 'mask' of the MaskedArray.
      a.partition(kth, axis=axis, kind=kind, order=order)
    /usr/local/anaconda3/envs/astroconda/lib/python3.7/site-packages/numpy/core/_asarray.py:136: UserWarning: Warning: converting a masked element to nan.
      return array(a, dtype, copy=False, order=order, subok=True)




.. GENERATED FROM PYTHON SOURCE LINES 78-79

Build an ePSF Model from the Gaia stars that are not saturated

.. GENERATED FROM PYTHON SOURCE LINES 79-83

.. code-block:: default

    searchim.build_epsf_model(verbose=False, save_suffix='TestEPSFModel')
    searchim.plot_epsf_model()





.. image:: /examples/images/sphx_glr_plot_epsfmodel_004.png
    :alt: plot epsfmodel
    :class: sphx-glr-single-img






.. rst-class:: sphx-glr-timing

   **Total running time of the script:** ( 0 minutes  4.270 seconds)


.. _sphx_glr_download_examples_plot_epsfmodel.py:


.. only :: html

 .. container:: sphx-glr-footer
    :class: sphx-glr-footer-example



  .. container:: sphx-glr-download sphx-glr-download-python

     :download:`Download Python source code: plot_epsfmodel.py <plot_epsfmodel.py>`



  .. container:: sphx-glr-download sphx-glr-download-jupyter

     :download:`Download Jupyter notebook: plot_epsfmodel.ipynb <plot_epsfmodel.ipynb>`


.. only:: html

 .. rst-class:: sphx-glr-signature

    `Gallery generated by Sphinx-Gallery <https://sphinx-gallery.github.io>`_
